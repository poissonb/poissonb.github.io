<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Extraction + Vérification signature PDF PKCS#7</title>

  <!-- Version corrigée avec des CDN fonctionnels -->
  <script src="https://unpkg.com/asn1js@2.0.32/build/asn1js.min.js"></script>
  <script src="https://unpkg.com/pkijs@3.0.15/build/index.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
<h1>Extraction + Vérification signature PDF PKCS#7</h1>

<input type="file" id="pdfFile" accept="application/pdf" />
<br/><br/>

<textarea id="signatureBase64" rows="6" cols="80" placeholder="Signature extraite en base64 (PKCS#7)"></textarea>
<br/><br/>

<button id="verifyBtn">Vérifier la signature</button>

<p id="result"></p>

<script>
  const { PDFDocument } = PDFLib;
  const { fromBER } = asn1js;
  const { ContentInfo, SignedData } = pkijs;

  const publicKeyPEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi+TKyKZDMZ994NfNVV8O
PkBHUGyldiUJPP2qXWFCQk6KyN1BIDP8+Y9fvRMMPyYHe3vcawgzPiySzQqkiPV0
C+UwrSxYtpWAk6+H7h9fBeI/Mq5lXAPv7btNWZ2L1SfJs2yubXCLXRQMgHkA8CM8
/n08NBb3zYG3drXXSDnrEGS3KFEUJZu0oSgh1RONP2gU921lCK0FHEba74igqwvZ
sgQhC8ooauDNhislyMfF9/k0WsfeL/gI+Ilz6PDxfM9iUbTcHbUmRAyeYavCtoUq
pHZ/SzyRuQHmcHeZCZ49ca0vD0TIj+ki3JoStZfXja+sIMkpHbHH01jJ1V9c+REH
9QIDAQAB
-----END PUBLIC KEY-----`;

  function pemToArrayBuffer(pem) {
    const b64 = pem.replace(/-----[^-]+-----/g, '').replace(/\s+/g, '');
    const binary = atob(b64);
    const buffer = new ArrayBuffer(binary.length);
    const view = new Uint8Array(buffer);
    for (let i = 0; i < binary.length; i++) {
      view[i] = binary.charCodeAt(i);
    }
    return buffer;
  }

  async function importPublicKey(pem) {
    const keyData = pemToArrayBuffer(pem);
    return await crypto.subtle.importKey(
      'spki',
      keyData,
      { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
      false,
      ['verify']
    );
  }

  async function extractSignatureFromPDF(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await PDFDocument.load(arrayBuffer);
    const form = pdfDoc.getForm();
    const fields = form.getFields();

    for (const field of fields) {
      if (field.constructor.name === 'PDFSignature') {
        const dict = field.acroField.dict;
        const contents = dict.get('Contents');
        if (!contents) throw new Error("Champ Contents introuvable dans la signature");
        let signatureBytes;
        if (contents.constructor.name === 'PDFHexString' || contents.constructor.name === 'PDFString') {
          signatureBytes = contents.asBytes();
        } else {
          throw new Error("Type de contenu Contents non supporté");
        }
        return new Uint8Array(signatureBytes);
      }
    }
    throw new Error("Aucune signature PDF détectée");
  }

  async function verifyPKCS7Signature(pkcs7Bytes, publicKey) {
    const asn1 = fromBER(pkcs7Bytes.buffer);
    if (asn1.offset === -1) throw new Error("Erreur d'analyse ASN.1");

    const contentInfo = new ContentInfo({ schema: asn1.result });
    if (contentInfo.contentType !== "1.2.840.113549.1.7.2
